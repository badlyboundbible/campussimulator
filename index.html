<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Campus Crisis Manager</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Manage your university through 4 years of crisis in this retro-style simulation game">
    <meta name="theme-color" content="#2a2a2a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Campus Crisis">
    
    <!-- PWA Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' fill='%23333'/%3E%3Ctext x='16' y='20' text-anchor='middle' fill='%23fff' font-family='monospace' font-size='16'%3E🏛️%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' fill='%23333'/%3E%3Ctext x='16' y='20' text-anchor='middle' fill='%23fff' font-family='monospace' font-size='16'%3E🏛️%3C/text%3E%3C/svg%3E">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        :root {
            /* Enhanced 16-bit Color Palette */
            --bg-dark: #1a1a1a;
            --bg-med: #2a2a2a;
            --bg-light: #3a3a3a;
            --border-main: #555555;
            --border-accent: #777777;
            --text-primary: #ffffff;
            --text-secondary: #e0e0e0;
            --text-dim: #aaaaaa;
            
            /* Scenario background - clean white for readability */
            --scenario-bg: #f8f8f8;
            --scenario-text: #333333;
            --scenario-border: #cccccc;
            
            /* Status Colors */
            --health-good: #00bb00;
            --health-warn: #ff9900;
            --health-bad: #dd0000;
            --crisis-bg: #440000;
            --crisis-border: #dd0000;
            
            /* Trend Colors */
            --trend-up: #00cc00;
            --trend-stable: #ffaa00;
            --trend-down: #cc0000;
            
            /* UI Colors */
            --button-bg: #444444;
            --button-hover: #555555;
            --button-active: #666666;
            --accent-blue: #3388dd;
            --accent-cyan: #00bbdd;
            --accent-yellow: #ddaa00;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Press Start 2P', monospace;
            font-size: 16px;
            line-height: 1.6;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-text-size-adjust: none;
            -moz-text-size-adjust: none;
            text-size-adjust: none;
        }
        
        /* Responsive font scaling - much more readable */
        @media (min-width: 768px) {
            body { font-size: 18px; }
        }
        
        @media (min-width: 1024px) {
            body { font-size: 20px; }
        }
        
        .game-container {
            max-width: 1200px;
            margin: 0 auto;
            min-height: 100vh;
            padding: 12px;
            background: 
                radial-gradient(circle at 25% 25%, rgba(51,136,221,0.1) 0%, transparent 25%),
                radial-gradient(circle at 75% 75%, rgba(221,170,0,0.05) 0%, transparent 25%),
                var(--bg-dark);
        }
        
        /* Enhanced 16-bit Style Borders */
        .pixel-border {
            border: 3px solid var(--border-main);
            background: var(--bg-med);
            position: relative;
        }
        
        .pixel-border::before {
            content: '';
            position: absolute;
            top: -1px;
            left: -1px;
            right: -1px;
            bottom: -1px;
            border: 1px solid var(--border-accent);
            pointer-events: none;
        }
        
        .pixel-border-thick {
            border: 4px solid var(--border-main);
            position: relative;
        }
        
        .pixel-border-thick::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border: 2px solid var(--border-accent);
            pointer-events: none;
        }
        
        /* Header */
        .game-header {
            text-align: center;
            margin-bottom: 16px;
            padding: 16px;
            background: linear-gradient(135deg, var(--bg-med), var(--bg-light));
        }
        
        .game-title {
            font-size: 1.2em;
            color: var(--accent-cyan);
            text-shadow: 2px 2px 0px var(--bg-dark);
            margin-bottom: 8px;
            letter-spacing: 1px;
        }
        
        .game-subtitle {
            font-size: 0.6em;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .game-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.7em;
            color: var(--text-dim);
            margin-top: 12px;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        @media (max-width: 600px) {
            .game-info {
                flex-direction: column;
                text-align: center;
                gap: 6px;
            }
        }
        
        /* Metrics Display */
        .metrics-container {
            margin-bottom: 20px;
            padding: 16px;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 12px;
            margin-bottom: 12px;
        }
        
        @media (max-width: 640px) {
            .metrics-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }
        
        .metric-card {
            background: var(--bg-light);
            border: 3px solid var(--border-main);
            padding: 12px;
            position: relative;
            min-height: 60px;
        }
        
        .metric-name {
            font-size: 0.7em;
            color: var(--text-secondary);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .metric-display {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }
        
        .metric-value {
            font-size: 1.2em;
            font-weight: bold;
            padding: 6px 12px;
            border: 2px solid var(--border-main);
            min-width: 50px;
            text-align: center;
        }
        
        .metric-value.good { 
            background: var(--health-good); 
            color: white;
            border-color: #00dd00;
        }
        .metric-value.warn { 
            background: var(--health-warn); 
            color: white;
            border-color: #ffbb00;
        }
        .metric-value.bad { 
            background: var(--health-bad); 
            color: white;
            border-color: #ff0000;
        }
        
        /* Enhanced Trend Indicators */
        .trend-indicator {
            width: 40px;
            height: 24px;
            background: var(--bg-dark);
            border: 2px solid var(--border-main);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .trend-display {
            width: 28px;
            height: 16px;
            display: flex;
            align-items: end;
            gap: 1px;
            padding: 2px;
        }
        
        .trend-bar {
            flex: 1;
            background: var(--trend-stable);
            min-height: 3px;
            transition: all 0.3s ease;
        }
        
        .trend-up { background: var(--trend-up) !important; }
        .trend-down { background: var(--trend-down) !important; }
        .trend-stable { background: var(--trend-stable) !important; }
        
        /* Scenario Display with White Background */
        .scenario-container {
            margin-bottom: 20px;
            padding: 16px;
        }
        
        .scenario-card {
            background: var(--scenario-bg);
            color: var(--scenario-text);
            border: 3px solid var(--scenario-border);
            padding: 20px;
            margin-bottom: 16px;
            position: relative;
        }
        
        .scenario-card::before {
            content: '';
            position: absolute;
            top: -1px;
            left: -1px;
            right: -1px;
            bottom: -1px;
            border: 1px solid #999999;
            pointer-events: none;
        }
        
        .scenario-title {
            font-size: 1.1em;
            color: var(--accent-yellow);
            background: var(--bg-dark);
            color: var(--text-primary);
            padding: 8px 12px;
            margin: -8px -8px 16px -8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: 2px solid var(--border-main);
        }
        
        .scenario-description {
            font-size: 1.1em;
            line-height: 1.8;
            color: var(--scenario-text);
            margin-bottom: 20px;
            background: white;
            padding: 20px;
            border: 2px solid #dddddd;
        }
        
        /* Crisis Styling */
        .crisis-scenario {
            background: var(--crisis-bg) !important;
            border-color: var(--crisis-border) !important;
            animation: crisis-pulse 2s infinite;
        }
        
        .crisis-scenario .scenario-description {
            background: #ffeeee !important;
            border-color: var(--crisis-border) !important;
            color: #990000 !important;
        }
        
        .crisis-title {
            background: var(--crisis-border) !important;
            color: white !important;
            animation: crisis-flash 1s infinite;
        }
        
        @keyframes crisis-pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(221, 0, 0, 0.3); }
            50% { box-shadow: 0 0 0 6px rgba(221, 0, 0, 0.1); }
        }
        
        @keyframes crisis-flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        /* Choice Buttons */
        .choices-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .choice-button {
            background: var(--button-bg);
            border: 3px solid var(--border-main);
            color: var(--text-primary);
            padding: 16px;
            font-family: inherit;
            font-size: 0.8em;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .choice-button:hover, .choice-button:focus {
            background: var(--button-hover);
            border-color: var(--accent-cyan);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .choice-button:active {
            background: var(--button-active);
            transform: translateY(0);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .choice-label {
            font-size: 0.9em;
            color: var(--accent-cyan);
            margin-bottom: 6px;
            text-transform: uppercase;
            font-weight: bold;
        }
        
        .choice-description {
            font-size: 0.9em;
            line-height: 1.6;
            color: var(--text-secondary);
        }
        
        /* Cultural Philosophy Colors */
        .choice-button.community { border-left: 6px solid #00bbdd; }
        .choice-button.individualistic { border-left: 6px solid #dd5555; }
        .choice-button.corporate { border-left: 6px solid #5555dd; }
        .choice-button.nurturing { border-left: 6px solid #55dd55; }
        
        /* Results Display */
        .results-container {
            margin-top: 20px;
            padding: 16px;
        }
        
        .results-card {
            background: var(--bg-light);
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .results-title {
            font-size: 0.9em;
            color: var(--accent-blue);
            margin-bottom: 12px;
            text-transform: uppercase;
        }
        
        .metric-changes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
            margin: 12px 0;
            font-size: 0.7em;
        }
        
        .metric-change {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            background: var(--bg-dark);
            border: 2px solid var(--border-main);
        }
        
        .change-positive { color: var(--health-good); font-weight: bold; }
        .change-negative { color: var(--health-bad); font-weight: bold; }
        .change-neutral { color: var(--text-dim); }
        
        /* Continue Button */
        .continue-button {
            width: 100%;
            background: var(--accent-blue);
            border: 3px solid var(--border-main);
            color: white;
            padding: 20px;
            font-family: inherit;
            font-size: 0.9em;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.2s ease;
        }
        
        .continue-button:hover {
            background: #4499ee;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        
        .continue-button:active {
            transform: translateY(0);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        /* Alert/Trigger Styling */
        .triggers-container {
            background: var(--health-warn);
            color: var(--bg-dark);
            padding: 12px;
            margin: 12px 0;
            border: 3px solid #ffcc00;
        }
        
        .triggers-title {
            font-size: 0.8em;
            font-weight: bold;
            margin-bottom: 6px;
        }
        
        .trigger-item {
            font-size: 0.7em;
            margin: 4px 0;
            line-height: 1.4;
        }
        
        /* Intro Screen */
        .intro-screen {
            text-align: center;
            padding: 20px;
            max-width: 100%;
        }
        
        .intro-content {
            background: var(--scenario-bg);
            color: var(--scenario-text);
            border: 3px solid var(--scenario-border);
            padding: 24px;
            margin: 16px 0;
        }
        
        .intro-title {
            font-size: 1.4em;
            color: var(--bg-dark);
            margin-bottom: 16px;
            text-shadow: none;
            background: var(--accent-cyan);
            color: white;
            padding: 12px;
            margin: -12px -12px 20px -12px;
        }
        
        .intro-text {
            font-size: 0.9em;
            line-height: 1.8;
            color: var(--scenario-text);
            margin-bottom: 16px;
            text-align: left;
        }
        
        .start-button {
            background: var(--health-good);
            border: 4px solid #00dd00;
            color: white;
            padding: 20px 32px;
            font-family: inherit;
            font-size: 1em;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 1px;
        }
        
        .start-button:hover {
            background: #00dd00;
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(0, 187, 0, 0.4);
        }
        
        /* Hidden class */
        .hidden {
            display: none !important;
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .choice-button {
                min-height: 90px;
                padding: 18px;
                font-size: 0.9em;
            }
            
            .choice-label {
                font-size: 1em;
            }
            
            .choice-description {
                font-size: 0.8em;
            }
            
            .continue-button {
                padding: 24px;
                font-size: 1em;
            }
            
            .game-container {
                padding: 8px;
            }
        }
        
        /* Very large screens */
        @media (min-width: 1400px) {
            .game-container {
                padding: 24px;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Intro Screen -->
    <div id="intro-screen" class="intro-screen">
        <div class="game-container">
            <div class="intro-content pixel-border">
                <div class="intro-title">🏛️ CAMPUS CRISIS MANAGER 🏛️</div>
                
                <div class="intro-text">
                    <strong>Welcome, Campus Manager!</strong><br><br>
                    
                    You've been appointed to manage a university through <strong>four years of crisis and transformation</strong>. 
                    Your decisions will shape the institution's future and determine what kind of educational community you create.<br><br>
                    
                    <strong>🎯 Your Mission:</strong><br>
                    Balance six key metrics while navigating crises, scandals, and recovery. Each decision reflects a different economic philosophy - choose wisely!<br><br>
                    
                    <strong>📊 Metrics to Manage:</strong><br>
                    • Financial Strength • Reputation • Research Quality<br>
                    • Staff Morale • Student Satisfaction • Local Impact<br><br>
                    
                    <strong style="color: #00bb00;">Green (70-100):</strong> Thriving<br>
                    <strong style="color: #ff9900;">Yellow (40-69):</strong> Warning<br>
                    <strong style="color: #dd0000;">Red (0-39):</strong> Crisis!<br><br>
                    
                    <strong>📈 Trend Indicators:</strong> Watch the mini-charts!<br>
                    <strong style="color: #00cc00;">Green bars:</strong> Improving trends<br>
                    <strong style="color: #ffaa00;">Yellow bars:</strong> Stable trends<br>
                    <strong style="color: #cc0000;">Red bars:</strong> Declining trends<br><br>
                    
                    <em>Every choice has consequences. There's no single "right" answer - explore different management philosophies!</em>
                </div>
                
                <button class="start-button pixel-border" onclick="startGame()">
                    🚀 Begin Your Journey
                </button>
            </div>
        </div>
    </div>

    <!-- Main Game Screen -->
    <div id="game-screen" class="game-container hidden">
        <!-- Header -->
        <div class="game-header pixel-border">
            <div class="game-title">CAMPUS CRISIS MANAGER</div>
            <div class="game-subtitle">16-BIT MANAGEMENT SIMULATOR</div>
            <div class="game-info">
                <span>Month: <span id="current-month">September</span></span>
                <span>Year: <span id="current-year">1</span></span>
                <span>Scenario: <span id="scenario-count">1</span> of 8</span>
            </div>
        </div>
        
        <!-- Metrics Display -->
        <div class="metrics-container pixel-border">
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-name">💰 Financial</div>
                    <div class="metric-display">
                        <div class="trend-indicator">
                            <div class="trend-display" id="financial-trend">
                                <div class="trend-bar"></div>
                                <div class="trend-bar"></div>
                                <div class="trend-bar"></div>
                                <div class="trend-bar"></div>
                            </div>
                        </div>
                        <div class="metric-value warn" id="financial-value">60</div>
                    </div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-name">⭐ Reputation</div>
                    <div class="metric-display">
                        <div class="trend-indicator">
                            <div class="trend-display" id="reputation-trend">
                                <div class="trend-bar"></div>
                                <div class="trend-bar"></div>
                                <div class="trend-bar"></div>
                                <div class="trend-bar"></div>
                            </div>
                        </div>
                        <div class="metric-value warn" id="reputation-value">65</div>
                    </div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-name">🔬 Research</div>
                    <div class="metric-display">
                        <div class="trend-indicator">
                            <div class="trend-display" id="research-trend">
                                <div class="trend-bar"></div>
                                <div class="trend-bar"></div>
                                <div class="trend-bar"></div>
                                <div class="trend-bar"></div>
                            </div>
                        </div>
                        <div class="metric-value good" id="research-value">70</div>
                    </div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-name">👥 Staff</div>
                    <div class="metric-display">
                        <div class="trend-indicator">
                            <div class="trend-display" id="staff-trend">
                                <div class="trend-bar"></div>
                                <div class="trend-bar"></div>
                                <div class="trend-bar"></div>
                                <div class="trend-bar"></div>
                            </div>
                        </div>
                        <div class="metric-value warn" id="staff-value">55</div>
                    </div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-name">🎓 Students</div>
                    <div class="metric-display">
                        <div class="trend-indicator">
                            <div class="trend-display" id="student-trend">
                                <div class="trend-bar"></div>
                                <div class="trend-bar"></div>
                                <div class="trend-bar"></div>
                                <div class="trend-bar"></div>
                            </div>
                        </div>
                        <div class="metric-value warn" id="student-value">60</div>
                    </div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-name">🏘️ Local</div>
                    <div class="metric-display">
                        <div class="trend-indicator">
                            <div class="trend-display" id="local-trend">
                                <div class="trend-bar"></div>
                                <div class="trend-bar"></div>
                                <div class="trend-bar"></div>
                                <div class="trend-bar"></div>
                            </div>
                        </div>
                        <div class="metric-value warn" id="local-value">50</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Scenario Display -->
        <div class="scenario-container pixel-border">
            <div class="scenario-card" id="scenario-card">
                <div class="scenario-title" id="scenario-title">Loading...</div>
                <div class="scenario-description" id="scenario-description">Preparing your first challenge...</div>
                <div class="choices-container" id="choices-container">
                    <!-- Choice buttons will be inserted here -->
                </div>
            </div>
        </div>
        
        <!-- Results Display -->
        <div class="results-container pixel-border hidden" id="results-container">
            <div class="results-card pixel-border">
                <div class="results-title" id="results-title">Results</div>
                <div id="results-content">
                    <!-- Results content will be inserted here -->
                </div>
                <button class="continue-button pixel-border" id="continue-button" onclick="nextScenario()">
                    Continue to Next Month
                </button>
            </div>
        </div>
    </div>

    <script>
        // Game state
        let gameState = {
            currentScenario: 0,
            currentMonth: 0,
            currentYear: 1,
            metrics: {
                financial: 60,
                reputation: 65,
                research: 70,
                staff: 55,
                student: 60,
                local: 50
            },
            metricsHistory: {
                financial: [60],
                reputation: [65],
                research: [70],
                staff: [55],
                student: [60],
                local: [50]
            },
            culturalChoices: {
                community: 0,
                individualistic: 0,
                corporate: 0,
                nurturing: 0
            }
        };

        // Complete scenarios array
        const scenarios = [
            {
                title: "Enrollment Surge Crisis",
                description: "Expected 3,000 students but 3,500 enrolled. Accommodation full, lecture halls overcrowded, staff stretched thin. Extra fees could help budget but quality suffers.",
                choices: [
                    {
                        label: "Community Response",
                        description: "Democratic meetings with all stakeholders for collaborative solutions",
                        effects: { financial: -5, reputation: 5, research: -10, staff: 15, student: 10, local: 5 },
                        culture: "community"
                    },
                    {
                        label: "Individualistic Response", 
                        description: "Accept all paying students - survival of the fittest",
                        effects: { financial: 15, reputation: 5, research: -5, staff: -5, student: -10, local: 0 },
                        culture: "individualistic"
                    },
                    {
                        label: "Corporate Response",
                        description: "Efficient systems and temporary solutions",
                        effects: { financial: 10, reputation: 5, research: 0, staff: -5, student: -5, local: 0 },
                        culture: "corporate"
                    },
                    {
                        label: "Nurturing Response",
                        description: "Cap numbers to maintain quality and support",
                        effects: { financial: 0, reputation: 10, research: 5, staff: 10, student: 15, local: 5 },
                        culture: "nurturing"
                    }
                ]
            },
            {
                title: "Teaching Resource Crisis",
                description: "Lecture halls packed, seminar groups doubled, senior staff complaining, junior lecturers burning out covering gaps.",
                choices: [
                    {
                        label: "Community Response",
                        description: "Staff-student committees to redistribute workload fairly",
                        effects: { financial: -10, reputation: 0, research: -10, staff: 15, student: 5, local: 5 },
                        culture: "community"
                    },
                    {
                        label: "Individualistic Response",
                        description: "Hire star lecturers with premium contracts",
                        effects: { financial: -20, reputation: 5, research: 5, staff: -10, student: 10, local: 0 },
                        culture: "individualistic"
                    },
                    {
                        label: "Corporate Response",
                        description: "Increase class sizes, implement efficiency measures",
                        effects: { financial: 10, reputation: -5, research: 0, staff: -10, student: -15, local: -5 },
                        culture: "corporate"
                    },
                    {
                        label: "Nurturing Response",
                        description: "Invest in support systems, reduce workload sustainably",
                        effects: { financial: -15, reputation: 5, research: 5, staff: 20, student: 10, local: 5 },
                        culture: "nurturing"
                    }
                ]
            },
            {
                title: "First Budget Pressures",
                description: "Government announces potential funding cuts. Early projections show overspending. Treasury demands immediate action.",
                choices: [
                    {
                        label: "Community Response",
                        description: "Open budget discussions with all stakeholders",
                        effects: { financial: -5, reputation: 10, research: 0, staff: 5, student: 5, local: 10 },
                        culture: "community"
                    },
                    {
                        label: "Individualistic Response",
                        description: "Cut underperforming departments, invest in winners",
                        effects: { financial: 15, reputation: 5, research: 10, staff: -15, student: -10, local: -5 },
                        culture: "individualistic"
                    },
                    {
                        label: "Corporate Response",
                        description: "Across-the-board efficiency savings",
                        effects: { financial: 20, reputation: 5, research: 0, staff: -10, student: -5, local: 0 },
                        culture: "corporate"
                    },
                    {
                        label: "Nurturing Response",
                        description: "Protect services, seek alternative funding",
                        effects: { financial: -10, reputation: 5, research: 5, staff: 10, student: 15, local: 10 },
                        culture: "nurturing"
                    }
                ]
            },
            {
                title: "Staff Workload Crisis",
                description: "Union complaint about 60+ hour weeks, double caseloads, spiking sick leave across departments.",
                choices: [
                    {
                        label: "Community Response",
                        description: "Joint working groups to redesign roles collaboratively",
                        effects: { financial: -10, reputation: 5, research: -5, staff: 20, student: 5, local: 5 },
                        culture: "community"
                    },
                    {
                        label: "Individualistic Response",
                        description: "Reward high performers, let others find their level",
                        effects: { financial: 5, reputation: 0, research: 10, staff: -20, student: -10, local: 0 },
                        culture: "individualistic"
                    },
                    {
                        label: "Corporate Response",
                        description: "Time management training and productivity monitoring",
                        effects: { financial: 5, reputation: -5, research: 0, staff: -15, student: -5, local: -5 },
                        culture: "corporate"
                    },
                    {
                        label: "Nurturing Response",
                        description: "Hire additional support, reduce individual workloads",
                        effects: { financial: -25, reputation: 5, research: 10, staff: 25, student: 15, local: 5 },
                        culture: "nurturing"
                    }
                ]
            },
            {
                title: "Pandemic Reports",
                description: "Virus spreading internationally. Conflicting government advice. Students and parents nervous, international students considering leaving.",
                choices: [
                    {
                        label: "Community Response",
                        description: "Crisis committee with representatives from all groups",
                        effects: { financial: -5, reputation: 10, research: 0, staff: 10, student: 15, local: 10 },
                        culture: "community"
                    },
                    {
                        label: "Individualistic Response",
                        description: "Continue normal operations - voluntary participation",
                        effects: { financial: 10, reputation: -15, research: 0, staff: -10, student: -15, local: -10 },
                        culture: "individualistic"
                    },
                    {
                        label: "Corporate Response",
                        description: "Evidence-based risk management protocols",
                        effects: { financial: 5, reputation: 15, research: 0, staff: 5, student: 5, local: 5 },
                        culture: "corporate"
                    },
                    {
                        label: "Nurturing Response",
                        description: "Health and safety above all other considerations",
                        effects: { financial: -15, reputation: 10, research: -5, staff: 15, student: 20, local: 15 },
                        culture: "nurturing"
                    }
                ]
            },
            {
                title: "Lockdown Chaos",
                description: "Government lockdown announced. Campus closed, online teaching overnight. Students demand fee reductions, staff struggle with tech.",
                choices: [
                    {
                        label: "Community Response",
                        description: "Collaborative emergency response - everyone helps everyone",
                        effects: { financial: -15, reputation: 10, research: -10, staff: 20, student: 15, local: 10 },
                        culture: "community"
                    },
                    {
                        label: "Individualistic Response",
                        description: "Sink or swim - adapt quickly or fall behind",
                        effects: { financial: 5, reputation: -10, research: 5, staff: -20, student: -25, local: -5 },
                        culture: "individualistic"
                    },
                    {
                        label: "Corporate Response",
                        description: "Rapid standardized online learning deployment",
                        effects: { financial: 10, reputation: 10, research: 0, staff: -5, student: -5, local: 0 },
                        culture: "corporate"
                    },
                    {
                        label: "Nurturing Response",
                        description: "Individual support for every student and staff member",
                        effects: { financial: -30, reputation: 15, research: 5, staff: 25, student: 25, local: 15 },
                        culture: "nurturing"
                    }
                ]
            },
            {
                title: "Financial Shortfall Crisis",
                description: "Pandemic costs + fee refunds + reduced international enrollment = massive budget hole. Treasury warns of potential insolvency.",
                choices: [
                    {
                        label: "Community Response",
                        description: "Transparent budget crisis meetings with all stakeholders",
                        effects: { financial: -5, reputation: 10, research: 0, staff: 10, student: 5, local: 15 },
                        culture: "community"
                    },
                    {
                        label: "Individualistic Response",
                        description: "Emergency cuts to lowest-performing areas only",
                        effects: { financial: 25, reputation: 0, research: 5, staff: -20, student: -15, local: -10 },
                        culture: "individualistic"
                    },
                    {
                        label: "Corporate Response",
                        description: "Systematic restructuring based on financial data",
                        effects: { financial: 30, reputation: 5, research: 0, staff: -15, student: -10, local: -5 },
                        culture: "corporate"
                    },
                    {
                        label: "Nurturing Response",
                        description: "Protect jobs and services, seek emergency funding",
                        effects: { financial: -20, reputation: 15, research: 5, staff: 20, student: 15, local: 20 },
                        culture: "nurturing"
                    }
                ]
            },
            {
                title: "Recovery Planning",
                description: "First positive signs emerging. How do you build on early success while avoiding complacency?",
                choices: [
                    {
                        label: "Community Response",
                        description: "Collective celebration and shared future planning",
                        effects: { financial: 10, reputation: 15, research: 10, staff: 20, student: 15, local: 20 },
                        culture: "community"
                    },
                    {
                        label: "Individualistic Response",
                        description: "Reward excellence, maintain competitive pressure",
                        effects: { financial: 20, reputation: 20, research: 25, staff: 5, student: 10, local: 5 },
                        culture: "individualistic"
                    },
                    {
                        label: "Corporate Response",
                        description: "Strategic consolidation and systematic improvement",
                        effects: { financial: 25, reputation: 15, research: 15, staff: 10, student: 10, local: 10 },
                        culture: "corporate"
                    },
                    {
                        label: "Nurturing Response",
                        description: "Holistic community healing and sustainable growth",
                        effects: { financial: 15, reputation: 20, research: 20, staff: 25, student: 25, local: 25 },
                        culture: "nurturing"
                    }
                ]
            }
        ];

        const months = [
            "September", "October", "November", "December", 
            "January", "February", "March", "April", 
            "May", "June", "July", "August"
        ];

        // Game functions
        function startGame() {
            document.getElementById('intro-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            updateAllMetrics();
            displayScenario();
        }

        function getMetricZone(value) {
            if (value >= 70) return "good";
            if (value >= 40) return "warn";
            return "bad";
        }

        function updateMetricDisplay(metricId, value) {
            const element = document.getElementById(metricId + '-value');
            if (element) {
                element.textContent = value;
                element.className = 'metric-value ' + getMetricZone(value);
            }
            updateTrendDisplay(metricId);
        }

        function updateTrendDisplay(metricId) {
            const history = gameState.metricsHistory[metricId];
            const trendContainer = document.getElementById(metricId + '-trend');
            
            if (!trendContainer) return;
            
            const bars = trendContainer.querySelectorAll('.trend-bar');
            
            // Always show 4 bars representing the last 4 values (including starting position)
            const recent = history.slice(-4);
            
            bars.forEach((bar, barIndex) => {
                if (barIndex < recent.length) {
                    const value = recent[barIndex];
                    
                    // Height based on actual value (0-100 scale)
                    const height = Math.max(10, Math.min(90, (value / 100) * 80 + 10));
                    
                    // Color based on change from previous value
                    let trendClass = 'trend-stable'; // Yellow for no change
                    
                    if (barIndex > 0) {
                        const currentValue = recent[barIndex];
                        const previousValue = recent[barIndex - 1];
                        const change = currentValue - previousValue;
                        
                        if (change > 0) trendClass = 'trend-up';        // Green for positive
                        else if (change < 0) trendClass = 'trend-down';  // Red for negative
                        else trendClass = 'trend-stable';                // Yellow for no change
                    }
                    
                    bar.className = `trend-bar ${trendClass}`;
                    bar.style.height = Math.round(height) + '%';
                    bar.style.opacity = '1';
                } else {
                    // No data yet - show neutral bar
                    bar.className = 'trend-bar trend-stable';
                    bar.style.height = '50%';
                    bar.style.opacity = '1';
                }
            });
        }

        function updateAllMetrics() {
            updateMetricDisplay('financial', gameState.metrics.financial);
            updateMetricDisplay('reputation', gameState.metrics.reputation);
            updateMetricDisplay('research', gameState.metrics.research);
            updateMetricDisplay('staff', gameState.metrics.staff);
            updateMetricDisplay('student', gameState.metrics.student);
            updateMetricDisplay('local', gameState.metrics.local);
        }

        function recordMetricsInHistory() {
            Object.keys(gameState.metrics).forEach(metric => {
                gameState.metricsHistory[metric].push(gameState.metrics[metric]);
                if (gameState.metricsHistory[metric].length > 8) {
                    gameState.metricsHistory[metric].shift();
                }
            });
        }

        function displayScenario() {
            if (gameState.currentScenario >= scenarios.length) {
                showGameComplete();
                return;
            }

            const scenario = scenarios[gameState.currentScenario];
            const scenarioCard = document.getElementById('scenario-card');
            const isCrisis = checkForCrisis();
            
            // Apply crisis styling if needed
            if (isCrisis) {
                scenarioCard.classList.add('crisis-scenario');
                document.getElementById('scenario-title').classList.add('crisis-title');
            } else {
                scenarioCard.classList.remove('crisis-scenario');
                document.getElementById('scenario-title').classList.remove('crisis-title');
            }
            
            document.getElementById('scenario-title').textContent = scenario.title;
            document.getElementById('scenario-description').textContent = scenario.description;
            
            const choicesContainer = document.getElementById('choices-container');
            choicesContainer.innerHTML = '';
            
            scenario.choices.forEach((choice, index) => {
                const button = document.createElement('button');
                button.className = `choice-button pixel-border ${choice.culture}`;
                button.onclick = () => makeChoice(index);
                
                button.innerHTML = `
                    <div class="choice-label">${choice.label}</div>
                    <div class="choice-description">${choice.description}</div>
                `;
                
                choicesContainer.appendChild(button);
            });
            
            // Hide results
            document.getElementById('results-container').classList.add('hidden');
        }

        function checkForCrisis() {
            return Object.values(gameState.metrics).some(value => value < 40);
        }

        function makeChoice(choiceIndex) {
            const scenario = scenarios[gameState.currentScenario];
            const choice = scenario.choices[choiceIndex];
            
            // Track cultural choice
            gameState.culturalChoices[choice.culture]++;
            
            // Apply effects
            const oldMetrics = {...gameState.metrics};
            Object.keys(choice.effects).forEach(metric => {
                gameState.metrics[metric] = Math.max(0, Math.min(100, gameState.metrics[metric] + choice.effects[metric]));
            });
            
            // Apply cascade effects
            const cascadeMessages = applyCascadeEffects();
            
            // Update display and record history
            updateAllMetrics();
            recordMetricsInHistory();
            
            // Show results
            showResults(choice, oldMetrics, cascadeMessages);
        }

        function applyCascadeEffects() {
            let messages = [];
            
            // Crisis cascades
            Object.keys(gameState.metrics).forEach(metric => {
                const value = gameState.metrics[metric];
                
                if (value < 40) {
                    switch(metric) {
                        case 'staff':
                            gameState.metrics.student = Math.max(0, gameState.metrics.student - 4);
                            gameState.metrics.research = Math.max(0, gameState.metrics.research - 4);
                            messages.push("💥 Staff crisis affecting teaching and research!");
                            break;
                        case 'student':
                            gameState.metrics.reputation = Math.max(0, gameState.metrics.reputation - 4);
                            gameState.metrics.financial = Math.max(0, gameState.metrics.financial - 3);
                            messages.push("💥 Student dissatisfaction damaging reputation!");
                            break;
                        case 'financial':
                            Object.keys(gameState.metrics).forEach(otherMetric => {
                                if (otherMetric !== 'financial') {
                                    gameState.metrics[otherMetric] = Math.max(0, gameState.metrics[otherMetric] - 3);
                                }
                            });
                            messages.push("💥 Financial crisis destroying operations!");
                            break;
                    }
                }
            });
            
            // Positive cascades
            if (gameState.metrics.staff >= 80) {
                gameState.metrics.student = Math.min(100, gameState.metrics.student + 2);
                gameState.metrics.research = Math.min(100, gameState.metrics.research + 2);
                messages.push("✨ High staff morale boosting performance!");
            }
            
            if (gameState.metrics.student >= 80) {
                gameState.metrics.reputation = Math.min(100, gameState.metrics.reputation + 2);
                messages.push("✨ Happy students boosting reputation!");
            }
            
            return messages;
        }

        function showResults(choice, oldMetrics, cascadeMessages) {
            const resultsContainer = document.getElementById('results-container');
            const resultsTitle = document.getElementById('results-title');
            const resultsContent = document.getElementById('results-content');
            
            resultsTitle.textContent = `Results: ${choice.label}`;
            
            let html = `<div class="intro-text" style="margin-bottom: 12px; font-style: italic; color: var(--text-secondary);">"${choice.description}"</div>`;
            
            // Metric changes
            html += '<div class="metric-changes">';
            Object.keys(choice.effects).forEach(metric => {
                const change = choice.effects[metric];
                const oldValue = oldMetrics[metric];
                const newValue = gameState.metrics[metric];
                const changeClass = change > 0 ? 'change-positive' : change < 0 ? 'change-negative' : 'change-neutral';
                const changeStr = change > 0 ? `+${change}` : `${change}`;
                
                html += `
                    <div class="metric-change">
                        <span>${metric.charAt(0).toUpperCase() + metric.slice(1)}</span>
                        <span class="${changeClass}">${oldValue} → ${newValue} (${changeStr})</span>
                    </div>
                `;
            });
            html += '</div>';
            
            // Cascade messages
            if (cascadeMessages.length > 0) {
                html += '<div class="triggers-container pixel-border">';
                html += '<div class="triggers-title">⚠️ CASCADE EFFECTS:</div>';
                cascadeMessages.forEach(msg => {
                    html += `<div class="trigger-item">${msg}</div>`;
                });
                html += '</div>';
            }
            
            // Crisis warnings
            const criticalMetrics = Object.keys(gameState.metrics).filter(m => gameState.metrics[m] < 40);
            if (criticalMetrics.length > 0) {
                html += '<div class="triggers-container pixel-border" style="background: var(--health-bad); color: white; border-color: var(--health-bad);">';
                html += '<div class="triggers-title">🚨 CRITICAL ALERTS:</div>';
                criticalMetrics.forEach(metric => {
                    html += `<div class="trigger-item">${metric.toUpperCase()} in crisis zone (${gameState.metrics[metric]})</div>`;
                });
                html += '</div>';
            }
            
            resultsContent.innerHTML = html;
            resultsContainer.classList.remove('hidden');
            
            // Scroll to results on mobile
            setTimeout(() => {
                resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        function nextScenario() {
            gameState.currentScenario++;
            gameState.currentMonth++;
            
            if (gameState.currentMonth >= 12) {
                gameState.currentMonth = 0;
                gameState.currentYear++;
            }
            
            // Update display
            document.getElementById('current-month').textContent = months[gameState.currentMonth];
            document.getElementById('current-year').textContent = gameState.currentYear;
            document.getElementById('scenario-count').textContent = gameState.currentScenario + 1;
            
            displayScenario();
        }

        function showGameComplete() {
            const dominantCulture = Object.keys(gameState.culturalChoices).reduce((a, b) => 
                gameState.culturalChoices[a] > gameState.culturalChoices[b] ? a : b
            );
            
            document.getElementById('scenario-title').textContent = '🎓 Transformation Complete!';
            document.getElementById('scenario-description').innerHTML = `
                Congratulations! You've guided your university through crisis and transformation.<br><br>
                <strong>Your Leadership Style:</strong> ${dominantCulture.charAt(0).toUpperCase() + dominantCulture.slice(1)}<br><br>
                <strong>Final Institution Profile:</strong><br>
                Look at your metrics above to see what kind of university you've created!
            `;
            
            document.getElementById('choices-container').innerHTML = `
                <button class="choice-button pixel-border" onclick="location.reload()" style="text-align: center;">
                    <div class="choice-label">🔄 Play Again</div>
                    <div class="choice-description">Try a different management philosophy</div>
                </button>
            `;
        }

        // PWA features work when hosted properly on HTTPS
        // Service worker registration removed for sandbox compatibility
        
        // Prevent zoom on double tap (iOS)
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            updateAllMetrics();
        });
    </script>
    
    <!-- PWA Manifest -->
    <script>
        // Create and inject manifest
        const manifest = {
            "name": "Campus Crisis Manager",
            "short_name": "Campus Crisis",
            "description": "Manage your university through crisis in this retro simulation game",
            "start_url": "/",
            "display": "standalone",
            "background_color": "#1a1a1a",
            "theme_color": "#2a2a2a",
            "orientation": "portrait",
            "icons": [
                {
                    "src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' fill='%23333'/%3E%3Ctext x='96' y='120' text-anchor='middle' fill='%23fff' font-family='monospace' font-size='80'%3E🏛️%3C/text%3E%3C/svg%3E",
                    "sizes": "192x192",
                    "type": "image/svg+xml"
                },
                {
                    "src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' fill='%23333'/%3E%3Ctext x='256' y='320' text-anchor='middle' fill='%23fff' font-family='monospace' font-size='200'%3E🏛️%3C/text%3E%3C/svg%3E",
                    "sizes": "512x512",
                    "type": "image/svg+xml"
                }
            ]
        };
        
        const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(manifestBlob);
        
        const link = document.createElement('link');
        link.rel = 'manifest';
        link.href = manifestURL;
        document.head.appendChild(link);
    </script>
</body>
</html>